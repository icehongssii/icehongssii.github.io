<html>
  <head>
    <!-- 사이트 제목 -->
    <title>icehongssii</title>
    <!-- 사이트 favicon -->
    <link
      rel="icon"
      href="/static/assets/icepersimmon.png"
      type="image/x-icon"
    />
    <meta charset="utf-8" />
    <!-- 코드하이라이터 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlightjs-line-numbers.js/dist/highlightjs-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dockerfile.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/shell.min.js"></script>
    <script>
      hljs.highlightAll();
    </script>
    <!-- 사이트 메타데이터-->
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <meta name="description" content="MOM, I am gonna rock" />
    <meta property="og:description" content="MOM, I am gonna rock" />
    <meta name="author" content="" />
    <!-- css파일-->
    <link rel="stylesheet" type="text/css" href="/static/style.css" />
    <!-- RSS피드-->
    <link
      rel="alternate"
      type="application/rss+xml"
      title="icehongssii"
      href="/feed.xml"
    />
  </head>

  <body>
    <div id="MathJax_Message" style="display: none"></div>
    <header>
      <!--사이트 메타데이터-->
      <div class="container">
        <div class="site-info">
          <a href="/" class="site-title">icehongssii</a>
          <p class="site-description">MOM, I am gonna rock</p>
        </div>
        <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---사이트메타-->

        <!--헤더-->
        <div class="grower"></div>
        <!--네이게이션바 3개-->
        <nav class="site-nav">
          <a href="/career"><img src="/static/assets/sun.svg" /></a>
          <p>ABOUT</p>
        </nav>
        <nav class="site-nav">
          <a href="/posts"><img src="/static/assets/monster.svg" /></a>
          <p>POSTS</p>
        </nav>
        <nav class="site-nav">
          <a href="/tags"><img src="/static/assets/cloud.svg" /></a>
          <p>TAGS</p>
        </nav>
        <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---네이게이션바3개-->
      </div>
      <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---헤더-->
    </header>

    <!--최상단 container-->
    <div id="main" role="main" class="container">
      <!--본문article-->
      <article class="post-page">
        <h1 class="title">k8s-서비스-외부로 서비스 노출하는 세가지방법</h1>
        <!--수정날짜-->
        <div class="date">
          <strong
            >마지막수정 2023-05-22T14:55:12 - 최초작성2023-05-02T14:55:12
          </strong>
        </div>
        <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!--수정날짜-->

        <!--메타데이터-->
        <div class="meta-information">
          <table>
            <tr>
              <td><strong>태그</strong></td>
              <td>
                
                <a href="/tags#2023-k8s-bootcamp"><span>2023-k8s-bootcamp</span></a>
                
                <a href="/tags#k8s"><span>k8s</span></a>
                
              </td>
            </tr>
            <tr>
              <td><strong>tl;dr</strong></td>
              <td>노드포트, 서비스 로드밸런서, ingress 이용해 외부로 서비스 노출</td>
            </tr>
          </table>
        </div>
        <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---메타데이터-->

        <!--마크다운변환된내용 본문-->
        <div class="entry"><h2>외부로 서비스 노출하는 세가지방법</h2>

<p>서비스를 노출하기 위한 방법
- nodeport : 노드 자체 포트 사용해 포드로 리다이렉션. 노드 자체 포트 열고 있음. 로드 밸랜서 사용하면 앞에 실제 로드 밸런서가 생긴다 그리고 뒷쪽에는 클라우드 환경에서 지원하는 쿠버네티스 클러스터 노드 3개가 떠있다 즉 쿠버네티스 클러스터. 이 쿠버네티스 클러스트는 노드의 포트를 열고 있는데 이걸 노드포트라고함. 
- loadbalancer : 이는 클라우드 환경에서 자주 사용함. 사내 프라이빗 클라우드 구성하고 이를 제공할 떄 로드밸런싱할 수 있도록 loadbalancer라는..클러스터를 클라우드 환경에서 제공할떄 로드밸런서라는걸 이용하면 쉽게 이용가능하다
- ingress : 인그레스는 하나의 아이피로 다수 서비스 이용가능.. lloadblaancer가 L4라면 ingress는 L7. 어디로 서비스 보낼지..? 도메인 이름 해석하는, 서비스를 어디다가 해</p>

<p>로밸(서비스), 잉그레스 -> 클라우드에서 자주사용<br />
노드포트(서비스) 자체 -> 물리적인 기능 즉 vm에서 자주 사용하고 vm에서 로밸 잉그레스 실습은 좀 어려움</p>

<p><img src="https://i.imgur.com/0XowSm3.png" alt="" /></p>

<h2>노드포트란?</h2>

<p>포트(svc),타겟포트(pod) 
- 노드 자체에 포트를 제공 
- 노트포트가 열려있고 클러스터 내에 서비스가 있음 근데 서비스가 동작하는게 아니라 네트워크 담당하는 kube-proxy가 패킷을 받아서 서비스에 등록된 룰을 적용시켜준다. 
- 30001번 포트가 큐브 프록시에 등록되어 라운드로빈으로 적절한  pod에 연결해준다 만약에 Pod가 노드에 없으면 kube proxy가 알아서 다른 노드에 있는 적절한 kube proxy와 연결해 Pod으로 연결해준다.
- 3가지 단계 -> 노드포트-서비스-포드
- 이때 노드포트의 범위는 30000-32767사이에 있는것만 사용가능하다 
- 노드에 직접 연결 할 수 있게 만드는 포트라고 생각하면 될 듯함</p>

<table>
<thead>
<tr>
  <th></th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td><img src="https://i.imgur.com/41F8o98.png" alt="" /></td>
  <td><img src="https://i.imgur.com/TIDIAPd.png" alt="" /></td>
</tr>
</tbody>
</table>

<blockquote>
  <p>[!important]<br />
  구글클라우드에서 CP에서 방화벽 해체줘야 노드로 직접 접속가능하다</p>
</blockquote>

<p><img src="https://i.imgur.com/g6mqbo8.png" alt="" /></p>

<ul>
<li>포트가 하나 연결되어 있으면 클러스터 ip 테이블 설정에 따라서 넷필터(들어오는 트래픽 정해진 규칙 따라 포워딩) 적절한 pod으로 분배가 된다 </li>
</ul>

<h2>노드포트 실습</h2>

<p>한편 서비스만 있으면 소용이 없으므로 pod이 띄어져있어야하는데 아래의 clusterIP타입의 서비스와 deploy를 생성하는 yaml로 리소스를 생성한다 </p>

<pre><code class="yaml language-yaml"># http-go-deploy.yaml
apiVersion: v1
kind: Service
metadata:
  name: http-go-svc
spec:
  selector:
    run: http-go
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
---

apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    run: http-go
  name: http-go
spec:
  replicas: 1
  selector:
    matchLabels:
      run: http-go
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        run: http-go
    spec:
      containers:
      - image: gasbugs/http-go
        name: http-go
        ports:
        - containerPort: 8080
        resources: {}
status: {}                
</code></pre>

<p>그리고 노드포트 타입 생성</p>

<pre><code class="yaml language-yaml"># http-go-np.yml
apiVersion: v1
kind: Service
metadata:
  name: http-go-np
spec:
  type: NodePort
  selector:
    run: http-go
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
      nodePort: 30001
</code></pre>

<p><img src="https://i.imgur.com/J7A1z0O.png" alt="" /><br />
이때 노드포트는 external IP가 없는데 저 옆에 있는 포트로 갈 수 있다. </p>

<pre><code>kubectl get nodes -o wide
</code></pre>

<p><img src="https://i.imgur.com/2F3w5GN.png" alt="" /></p>

<p>이때 각 노드의 IP:30001번으로 외부에서 접근가능하다 </p>

<blockquote>
  <p>[!important]  방화벽을 열어둬야 외부에서 접근가능
  ```
  gcloud compute firewall-rules create http-go-svc-rule --allow=tcp:30001</p>
</blockquote>

<h2>서비스 로드밸런서란?</h2>

<ul>
<li>클라우드 환경에서만 사용가능</li>
<li>노드포트의 확장서비스</li>
<li>로드 밸런서 IP주소를 통해 서비스에 접근 </li>
<li>이때 이 로드밸런스 타입의 서비스는 노트포트의 기능을 포함한다 </li>
</ul>

<table>
<thead>
<tr>
  <th></th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td><img src="https://i.imgur.com/dE4IdDF.png" alt="" /></td>
  <td><img src="https://i.imgur.com/UAln1JD.png" alt="" /></td>
</tr>
</tbody>
</table>

<p>vm에서 안되고 클라우드 서비스에서만 가능<br />
L4장비</p>

<p><img src="https://i.imgur.com/U1sKGjQ.png" alt="" /></p>

<p>30533은 임의로 정해진건<br />
로드밸런서는 노드포트에 직접 연결되고 클러스터 IP로 통신함</p>

<h2>로드밸런서 + GCP</h2>

<p>그전에 생성한 리소스 지우고 실행 </p>

<pre><code class="yaml language-yaml">
# http-go-lb.yaml
apiVersion: v1
kind: Service
metadata:
  name: http-go-lb
spec:
  type: LoadBalancer
  selector:
    run: http-go
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080

---
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    run: http-go
  name: http-go
spec:
  replicas: 1
  selector:
    matchLabels:
      run: http-go
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        run: http-go
    spec:
      containers:
      - image: gasbugs/http-go
        name: http-go
        ports:
        - containerPort: 8080
        resources: {}
status: {}
</code></pre>

<p>ip 할당 받을 때 까지 기다려야함📝<br />
이제는 노드외부IP:30001아니라 80포트로 접속됨<br />
구글 클라우드에서 GCP 로드밸런서를 생성해줌  </p>

<table>
<thead>
<tr>
  <th></th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td><img src="https://i.imgur.com/2SOrUJi.png" alt="" /></td>
  <td><img src="https://i.imgur.com/DMlPemq.png" alt="" /></td>
</tr>
</tbody>
</table>

<pre><code>curl 35.202.128.171
</code></pre>

<h2>📝 연습문제</h2>

<ul>
<li>tomcat 노드포트로 서비스(30002 포트)</li>
<li>tomcat을 로드 밸런스로 서비스하기(80번 포트)</li>
</ul>

<h2>📝 연습문제 답안</h2>

<ul>
<li>tomcat 노드포트로 서비스(30002 포트)</li>
</ul>

<p>필요한게  deploy, service(노드포트)</p>

<pre><code># 톰캣 디플로이
:k  create depoy tomcat --image=consol/tomcat-7.0 --dry-run=client --port=8080 -o yaml &gt;&gt; tomcat-deploy-lb-np.yaml 
</code></pre>

<pre><code># 노드포트
k create service nodeport tomcat-np --tcp=80:8080 --dry-run=client -o yaml 
</code></pre>

<p>를 <code>tomcat-deploy-lb-np.yaml</code>에 붙여넣고<br />
<code>NodePort: 30002</code> 붙이고 서비스 selector에 app=tomcat으로 태그 변경 </p>

<pre><code># tomcat-deploy-np-lb.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: tomcat
  name: tomcat
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tomcat
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: tomcat
    spec:
      containers:
      - image: consol/tomcat-7.0
        name: tomcat-7-0-xqbmr
        ports:
        - containerPort: 8080
        resources: {}
status: {}
---
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: null
  labels:
    app: tomcat-np
  name: tomcat-np
spec:
  ports:
  - name: 80-8080
    port: 80
    protocol: TCP
    targetPort: 8080
    nodePort: 30002
  selector:
    app: tomcat
  type: NodePort
status:
  loadBalancer: {}
</code></pre>

<pre><code>k scale rs [생성된rs이름] --replicas=5
curl [노드외부IP]:30002
</code></pre>

<p>두개의 노드에서 확인해보면 tomcat 페이지 나오는거 확인가능</p>

<ul>
<li>노드포트 사용하는경우 30002 풀어야</li>
</ul>

<p><img src="https://i.imgur.com/wLIGbJg.png" alt="" /></p>

<ul>
<li>tomcat을 로드 밸런스로 서비스하기(80번 포트)</li>
</ul>

<pre><code>k create service loadbalancer tomcat-lb --dry-run=client --tcp=80:8080 -o yaml
</code></pre>

<p>이때 나온 결과 <code># tomcat-deploy-np-lb.yaml</code>에 붙여넣 고 <code>k apply -f tomcat-deploy-np-lb.yaml</code><br />
이때 <code>k get svc</code>에 나온 로드밸런서의 외부 IP:80으로 curl해보면 접근가능한 것 확인 가능</p>

<h2>Ingress란?</h2>

<p><img src="https://i.imgur.com/vAUHAkg.png" alt="" /></p>

<p>ingress앞에 배치하면 도메인이나, URI, URL에 따라서 gasbug.com 그때는 1번 포드, nodejs.gasbug면 2번 포드, 3번째는 URI, 요청들어오면 서비스 연결한다.<br />
사용자는 하나의 ip를 쓰면서 URI, 포트등으로 나눌 수 있다.</p>

<blockquote>
  <p>하나의 IP와 하나의 포트로 다수의 어플리케이션을 사용할 수 있다.</p>
</blockquote>

<h2>Ingress-nginx이용</h2>

<table>
<thead>
<tr>
  <th></th>
  <th></th>
</tr>
</thead>
<tbody>
<tr>
  <td><img src="https://i.imgur.com/qmMrwtP.png" alt="" /></td>
  <td><img src="https://i.imgur.com/vww5GVl.png" alt="" /></td>
</tr>
</tbody>
</table>

<ul>
<li>클러스터안에 수많은 노드가있고 거기에 nginx띄어놓. nginx는 내부적으로 포워딩하는 기능 포함함. 근데 nginx ingress사용하면 포트 분석해서 그 룰을 동적으로 세팅하게끔 해주는 기능을 사용할 수 있다.  외부 사용자가 클러스터에 접근하면 nginx가 적절한 서비스를 연결하게 할 수 있다. </li>
<li>gcp에서 제공해주는 클러스터앞에 ALB가 nginx ingress같은 룰을 적용함</li>
</ul>

<p>이때 둘의 아키텍처는 다르지만 클러스터 내부에서 분산되는거고,  URI나 도메인으로 분산시스템 구축하는건 같다.</p>

<h2>Ingress-nginx 설치(230522)</h2>

<pre><code class="yaml language-yaml">git clone https://github.com/kubernetes/ingress-nginx/
kubectl apply -k `pwd`/ingress-nginx/deploy/static/provider/baremetal/
# 마지막은 웹훅구성삭제. 이기능으로  ingress 잘 안되는 현상있어서
kubectl delete validatingwebhookconfigurations.admissionregistration.k8s.io ingress-nginx-admission
</code></pre>

<p>nginx ingress설치하면 ingress라는 룰을 그 자원을 만들면 정보를 읽어서 그룰대로 세팅</p>

<p><img src="https://i.imgur.com/OuVPY9b.png" alt="" /></p>

<h2>Ingress실습</h2>

<pre><code class="yaml language-yaml">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: http-go-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /welcome/test
spec:
  rules:
    - http:
        paths:
          - pathType: Exact
            path: /welcome/test
            backend:
              service:
                name: http-go
                port: 
                  number: 80
EOF
</code></pre>

<p>ingress-nginx 네임스페이스에 생성되어있다 </p>

<pre><code>k get all -n  ingress-nginx
</code></pre>

<p>서비스 구성</p>

<pre><code class="sh language-sh">kubectl create deployment http-go --image=gasbugs/http-go:ingress # 인그레스 테스트용 http-go
kubectl expose deployment http-go --port=80 --target-port=8080
</code></pre>

<pre><code>kubectl exec -it http-go-759bdc4cf8-rv9gf --bash
# 404 페이지가 뜬가
$ curl 127.0.0.1:8080 
# ingress 룰 설정이 잘 된 모습
$ curl 127.0.0.1:8080/welcome/test 

</code></pre>

<p>어디로 요청보내야 뒤에있는 노드로 전달할수있을까?<br />
kubectl get all -n ingress-nginx 네임스페이스에서 <code>ingress-nginx-controller</code>로 접근하면된다</p>

<p><img src="https://i.imgur.com/rQk6NgW.png" alt="" /></p>

<p>ingree-nginx-controller 31471 포트로보내면 파드가 아니라 앞에 있는 nginx가 요청을 받게 되므로</p>

<p><code>curl 127.0.0.1:31471/welcome/test</code> 로 요청을 보내야<br />
파드의 결과가 나온다<br />
<img src="https://i.imgur.com/aterMgk.png" alt="" /></p>

<h2>Ref</h2>

<ul>
<li>인프런 - devops를 위한 쿠버네티스</li>
</ul>
</div>
        <!----><!----><!----><!----><!----><!----><!----><!----><!----><!--마크다운변환된내용 본문-->

        <!--댓글-->
        <hr />
        <div>
          <script
            src="https://utteranc.es/client.js"
            repo="icehongssii/icehongssii.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async
          ></script>
        </div>
        <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!--댓글-->

        <!--홍씨바닥-->
        <div>
          <center>
            <img src="/static/assets/icepersimmon.png" class="my-icon" />
          </center>
        </div>
        <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---홍씨바닥-->
      </article>
      <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!---본문article-->
    </div>
    <!----><!----><!----><!----><!----><!----><!----><!----><!----><!----><!--최상단 container-->

    <footer>
      <div class="container">
        <p><a href="mailto:icehongssii@gmail.com">icehongssii@gmail.com</a></p>
        <p><a href="https://github.com/icehongssii">GitHub @icehongssii</a></p>
      </div>
    </footer>
    <!-- Google Analytics -->
    <!-- End Google Analytics -->
  </body>
</html>